name: Docs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-docs:
    name: Build Docs Preview
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout docs repository
        uses: actions/checkout@v4
        with:
          repository: tenzir/docs
          path: docs-repo
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: docs-repo/pnpm-lock.yaml

      - name: Install dependencies
        run: |
          cd docs-repo
          pnpm install --frozen-lockfile

      - name: Update reference docs
        run: |
          rsync -av --delete ./docs/functions/ ./docs-repo/src/content/docs/reference/functions
          rsync -av --delete ./docs/operators/ ./docs-repo/src/content/docs/reference/operators
          cp ./docs/openapi.node.yaml ./docs-repo/src/content/apis/openapi.node.yaml
          cp ./tenzir.yaml.example ./docs-repo/tenzir.yaml.example
          cd docs-repo
          pnpm run generate:reference
          pnpm sync:changelog

      - name: Build docs with Astro
        id: build
        run: |
          cd docs-repo
          pnpm astro build --site "https://tenzir-tenzir-preview-${{ github.event.pull_request.number }}.surge.sh"
        continue-on-error: true

      - name: Deploy to Surge
        id: deploy
        if: steps.build.outcome == 'success'
        run: |
          cd docs-repo
          npm install -g surge
          surge ./dist https://tenzir-tenzir-preview-${{ github.event.pull_request.number }}.surge.sh --token ${{ secrets.SURGE_TOKEN }}
        continue-on-error: true

      - name: Post docs preview comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PREVIEW_URL="https://tenzir-tenzir-preview-$PR_NUMBER.surge.sh"

          if [ "${{ steps.build.outcome }}" = "success" ] && [ "${{ steps.deploy.outcome }}" = "success" ]; then
            COMMENT_BODY="<!-- docs-preview -->
          ## üìö Documentation Preview

          ‚úÖ **Docs preview is ready!**

          üîó **Preview**: [$PREVIEW_URL]($PREVIEW_URL)

          *Updated automatically when you push new commits.*"
          else
            COMMENT_BODY="<!-- docs-preview -->
          ## üìö Documentation Preview

          ‚ùå **Docs preview build failed**

          Check the workflow logs for details."
          fi

          # Check if a comment already exists
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            --jq '.[] | select(.body | startswith("<!-- docs-preview -->")) | .id' | head -1)

          if [ -n "$COMMENT_ID" ]; then
            gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
              -X PATCH \
              -f body="$COMMENT_BODY"
          else
            gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
              -f body="$COMMENT_BODY"
          fi
