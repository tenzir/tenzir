"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[79887],{15680:(e,n,t)=>{t.d(n,{xA:()=>u,yg:()=>m});var i=t(96540);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function r(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var p=i.createContext({}),s=function(e){var n=i.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=s(e.components);return i.createElement(p.Provider,{value:n},e.children)},g="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),g=s(t),d=a,m=g["".concat(p,".").concat(d)]||g[d]||c[d]||o;return t?i.createElement(m,l(l({ref:n},u),{},{components:t})):i.createElement(m,l({ref:n},u))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,l=new Array(o);l[0]=d;var r={};for(var p in n)hasOwnProperty.call(n,p)&&(r[p]=n[p]);r.originalType=e,r[g]="string"==typeof e?e:a,l[1]=r;for(var s=2;s<o;s++)l[s]=t[s];return i.createElement.apply(null,l)}return i.createElement.apply(null,t)}d.displayName="MDXCreateElement"},47341:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>f,contentTitle:()=>y,default:()=>w,frontMatter:()=>m,metadata:()=>h,toc:()=>b});var i=t(15680),a=Object.defineProperty,o=Object.defineProperties,l=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,p=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,u=(e,n,t)=>n in e?a(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,g=(e,n)=>{for(var t in n||(n={}))p.call(n,t)&&u(e,t,n[t]);if(r)for(var t of r(n))s.call(n,t)&&u(e,t,n[t]);return e},c=(e,n)=>o(e,l(n)),d=(e,n)=>{var t={};for(var i in e)p.call(e,i)&&n.indexOf(i)<0&&(t[i]=e[i]);if(null!=e&&r)for(var i of r(e))n.indexOf(i)<0&&s.call(e,i)&&(t[i]=e[i]);return t};const m={},y="Write a Plugin",h={unversionedId:"development/write-a-plugin",id:"version-v4.19/development/write-a-plugin",title:"Write a Plugin",description:"Implementing a new plugin requires the following steps:",source:"@site/versioned_docs/version-v4.19/development/write-a-plugin.md",sourceDirName:"development",slug:"/development/write-a-plugin",permalink:"/development/write-a-plugin",draft:!1,editUrl:"https://github.com/tenzir/tenzir/tree/main/web/versioned_docs/version-v4.19/development/write-a-plugin.md",tags:[],version:"v4.19",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Build the Docker image",permalink:"/development/build-the-docker-image"},next:{title:"Troubleshooting",permalink:"/troubleshooting"}},f={},b=[{value:"Setup the scaffolding",id:"setup-the-scaffolding",level:2},{value:"Choose a plugin type",id:"choose-a-plugin-type",level:2},{value:"Implement the plugin interface",id:"implement-the-plugin-interface",level:2},{value:"Process configuration options",id:"process-configuration-options",level:2},{value:"Compile the source code",id:"compile-the-source-code",level:2},{value:"Building alongside Tenzir",id:"building-alongside-tenzir",level:3},{value:"Building against an installed Tenzir",id:"building-against-an-installed-tenzir",level:3},{value:"Add unit and integration tests",id:"add-unit-and-integration-tests",level:2},{value:"Unit tests",id:"unit-tests",level:3},{value:"Integration tests",id:"integration-tests",level:3},{value:"Package it",id:"package-it",level:2}],v={toc:b},N="wrapper";function w(e){var n=e,{components:t}=n,a=d(n,["components"]);return(0,i.yg)(N,c(g(g({},v),a),{components:t,mdxType:"MDXLayout"}),(0,i.yg)("h1",g({},{id:"write-a-plugin"}),"Write a Plugin"),(0,i.yg)("p",null,"Implementing a new plugin requires the following steps:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("a",g({parentName:"li"},{href:"#setup-the-scaffolding"}),"Setup the scaffolding")),(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("a",g({parentName:"li"},{href:"#choose-a-plugin-type"}),"Choose a plugin type")),(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("a",g({parentName:"li"},{href:"#implement-the-plugin-interface"}),"Implement the plugin interface")),(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("a",g({parentName:"li"},{href:"#process-configuration-options"}),"Process configuration options")),(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("a",g({parentName:"li"},{href:"#compile-the-source-code"}),"Compile the source code")),(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("a",g({parentName:"li"},{href:"#add-unit-and-integration-tests"}),"Add unit and integration tests")),(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("a",g({parentName:"li"},{href:"#package-it"}),"Package it"))),(0,i.yg)("p",null,"Next, we'll discuss each step in more detail."),(0,i.yg)("h2",g({},{id:"setup-the-scaffolding"}),"Setup the scaffolding"),(0,i.yg)("p",null,"The scaffolding of a plugin includes the CMake glue that makes it possible to\nuse as static or dynamic plugin."),(0,i.yg)("p",null,"Pass ",(0,i.yg)("inlineCode",{parentName:"p"},"-DTENZIR_ENABLE_STATIC_PLUGINS:BOOL=ON")," to ",(0,i.yg)("inlineCode",{parentName:"p"},"cmake")," to build plugins\nalongside Tenzir as static plugins. This option is always on for static binary\nbuilds."),(0,i.yg)("p",null,"Tenzir ships with many plugins that showcase what a typical scaffold looks like.\nHave a look at the the\n",(0,i.yg)("a",g({parentName:"p"},{href:"https://github.com/tenzir/tenzir/tree/main/plugins"}),"plugins")," directory, and an\n",(0,i.yg)("a",g({parentName:"p"},{href:"https://github.com/tenzir/tenzir/blob/main/plugins/amqp/CMakeLists.txt"}),"example ",(0,i.yg)("inlineCode",{parentName:"a"},"CMakeLists.txt")," file from the AMQP\nplugin"),"."),(0,i.yg)("p",null,"We highly urge calling the provided ",(0,i.yg)("inlineCode",{parentName:"p"},"TenzirRegisterPlugin")," CMake in your plugin's\n",(0,i.yg)("inlineCode",{parentName:"p"},"CMakeLists.txt")," file instead of handrolling your CMake build scaffolding\ncode. This ensures that your plugin always uses the recommended defaults.\nNon-static installations of Tenzir contain the ",(0,i.yg)("inlineCode",{parentName:"p"},"TenzirRegisterPlugin.cmake"),"\nmodules."),(0,i.yg)("p",null,"The typical structure of a plugin directory includes the following\nfiles/directories:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("inlineCode",{parentName:"p"},"README.md"),": An overview of the plugin and how to use it.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("inlineCode",{parentName:"p"},"CHANGELOG.md"),": A trail of user-facing changes.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("inlineCode",{parentName:"p"},"schema/"),": new schemas that ship with this plugin.")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("inlineCode",{parentName:"p"},"<plugin>.yaml.example"),": the configuration knobs of the plugin. We comment out\nall options by default so that the file serves as reference. Users can\nuncomment specific settings they would like to adapt."),(0,i.yg)("p",{parentName:"li"},"The CMake build scaffolding installs all of the above files/directories, if\npresent."))),(0,i.yg)("h2",g({},{id:"choose-a-plugin-type"}),"Choose a plugin type"),(0,i.yg)("p",null,"Tenzir offers ",(0,i.yg)("a",g({parentName:"p"},{href:"/architecture/plugins#plugin-types"}),"a variety of customization\npoints"),", each of which defines its\nown API by inheriting from the plugin base class ",(0,i.yg)("inlineCode",{parentName:"p"},"tenzir::plugin"),". When writing\na new plugin, you can choose a subset of available types by inheriting from the\nrespective plugin classes."),(0,i.yg)("admonition",g({},{title:"Dreaded Diamond",type:"caution"}),(0,i.yg)("p",{parentName:"admonition"},"To avoid common issues with multiple inheritance, all intermediate plugin\nclasses that inherit from ",(0,i.yg)("inlineCode",{parentName:"p"},"tenzir::plugin")," use ",(0,i.yg)("em",{parentName:"p"},"virtual inheritance")," to avoid\nissues with the ",(0,i.yg)("a",g({parentName:"p"},{href:"https://isocpp.org/wiki/faq/multiple-inheritance#mi-diamond"}),"dreaded\ndiamond"),".")),(0,i.yg)("h2",g({},{id:"implement-the-plugin-interface"}),"Implement the plugin interface"),(0,i.yg)("p",null,"After having the necessary CMake in place, you can now derive from one or more\nplugin base classes to define your own plugin. Based on the chosen plugin\ntypes, you must override one or more virtual functions with an implementation\nof your own."),(0,i.yg)("p",null,"The basic anatomy of a plugin class looks as follows:"),(0,i.yg)("pre",null,(0,i.yg)("code",g({parentName:"pre"},{className:"language-cpp"}),"class example_plugin final : public virtual component_plugin,\n                             public virtual command_plugin {\npublic:\n  /// Loading logic.\n  example_plugin();\n\n  /// Teardown logic.\n  ~example_plugin() override;\n\n  /// Initializes a plugin with its respective entries from the YAML config\n  /// file, i.e., `plugin.<NAME>`.\n  /// @param plugin_config The relevant subsection of the configuration.\n  /// @param global_config The entire Tenzir configuration for potential access\n  /// to global options.\n  caf::error initialize(const record& plugin_config,\n                        const record& global_config) override;\n\n  /// Returns the unique name of the plugin.\n  std::string name() const override;\n\n  // TODO: override pure virtual functions from the base classes.\n  // ...\n};\n")),(0,i.yg)("p",null,"The plugin constructor should only perform minimal actions to instantiate a\nwell-defined plugin instance. In particular, it should not throw or perform any\noperations that may potentially fail. For the actual plugin ramp up, please use\nthe ",(0,i.yg)("inlineCode",{parentName:"p"},"initialize")," function that processes the user configuration. The purpose of\nthe destructor is to free any used resources owned by the plugin."),(0,i.yg)("p",null,"Each plugin must have a unique name. This returned string should consicely\nidentify the plugin internally."),(0,i.yg)("p",null,"Please consult the documentation specific to each plugin type above to figure\nout what virtual function need overriding. In the above example, we have a\n",(0,i.yg)("inlineCode",{parentName:"p"},"command_plugin")," and a ",(0,i.yg)("inlineCode",{parentName:"p"},"component_plugin"),". This requires implementing the\nfollowing two interfaces:"),(0,i.yg)("pre",null,(0,i.yg)("code",g({parentName:"pre"},{className:"language-cpp"}),"component_plugin_actor make_component(\n  node_actor::stateful_pointer<node_state> node) const override;\n\nstd::pair<std::unique_ptr<command>, command::factory>\nmake_command() const override;\n")),(0,i.yg)("p",null,"After completing the implementation, you must now register the plugin. For\nexample, to register the ",(0,i.yg)("inlineCode",{parentName:"p"},"example")," plugin, include the following line after the\nplugin class definition:"),(0,i.yg)("pre",null,(0,i.yg)("code",g({parentName:"pre"},{className:"language-cpp"}),"// This line must not be in a namespace.\nTENZIR_REGISTER_PLUGIN(tenzir::plugins::example_plugin)\n")),(0,i.yg)("admonition",g({},{title:"Registering Type IDs",type:"tip"}),(0,i.yg)("p",{parentName:"admonition"},"The example plugin also shows how to register additional type IDs with the actor\nsystem configuration, which is a requirement for sending custom types from the\nplugin between actors. For more information, please refer to the CAF\ndocumentation page ",(0,i.yg)("a",g({parentName:"p"},{href:"https://actor-framework.readthedocs.io/en/stable/ConfiguringActorApplications.html#adding-custom-message-types"}),"Configuring Actor Applications: Adding Custom Message\nTypes"),".")),(0,i.yg)("h2",g({},{id:"process-configuration-options"}),"Process configuration options"),(0,i.yg)("p",null,"To configure a plugin at runtime, Tenzir first looks whether the YAML\nconfiguration contains a key with the plugin name under the top-level key\n",(0,i.yg)("inlineCode",{parentName:"p"},"plugins"),". Consider our example plugin with the name ",(0,i.yg)("inlineCode",{parentName:"p"},"example"),":"),(0,i.yg)("pre",null,(0,i.yg)("code",g({parentName:"pre"},{className:"language-yaml"}),"plugins:\n  example:\n    option: 42\n")),(0,i.yg)("p",null,"Here, the plugin receives the record ",(0,i.yg)("inlineCode",{parentName:"p"},"{option: 42}")," at load time. A plugin can\nprocess the configuration snippet by overriding the following function of\n",(0,i.yg)("inlineCode",{parentName:"p"},"tenzir::plugin"),":"),(0,i.yg)("pre",null,(0,i.yg)("code",g({parentName:"pre"},{}),"caf::error initialize(const record& plugin_config,\n                      const record& global_config) override;\n")),(0,i.yg)("p",null,"Tenzir expects the plugin to be fully operational after calling ",(0,i.yg)("inlineCode",{parentName:"p"},"initialize"),".\nSubsequent calls to the implemented customization points must have a\nwell-defined behavior."),(0,i.yg)("h2",g({},{id:"compile-the-source-code"}),"Compile the source code"),(0,i.yg)("h3",g({},{id:"building-alongside-tenzir"}),"Building alongside Tenzir"),(0,i.yg)("p",null,"When configuring the Tenzir build, you need to tell CMake the path to the plugin\nsource directory. The CMake variable ",(0,i.yg)("inlineCode",{parentName:"p"},"TENZIR_PLUGINS")," holds a comma-separated\nlist of paths to plugin directories."),(0,i.yg)("p",null,"To test that Tenzir loads the plugin properly, you can use ",(0,i.yg)("inlineCode",{parentName:"p"},"tenzir\n--plugins=example version")," and look into the ",(0,i.yg)("inlineCode",{parentName:"p"},"plugins"),". A key-value pair with\nyour plugin name and version should exist in the output."),(0,i.yg)("p",null,"Refer to the ",(0,i.yg)("a",g({parentName:"p"},{href:"/configuration#load-plugins"}),"plugin loading")," section of\nthe documentation to find out how to explicitly de-/activate plugins."),(0,i.yg)("h3",g({},{id:"building-against-an-installed-tenzir"}),"Building against an installed Tenzir"),(0,i.yg)("p",null,"It is also possible to build plugins against an installed Tenzir. The\n",(0,i.yg)("inlineCode",{parentName:"p"},"TenzirRegisterPlugin")," CMake function contains the required scaffolding to set\nup ",(0,i.yg)("inlineCode",{parentName:"p"},"test")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"integration")," targets that mimic Tenzir's targets. Here's how you\ncan use it:"),(0,i.yg)("pre",null,(0,i.yg)("code",g({parentName:"pre"},{className:"language-bash"}),"# Configure the build. Requires Tenzir to be installed in the CMake Module Path.\ncmake -S path/to/plugin -B build\n# Optionally you can manually specify a non-standard Tenzir install root:\n#   TENZIR_DIR=/opt/tenzir cmake -S path/to/plugin -B build\ncmake --build build\n# Run plugin-specific unit tests.\nctest --test-dir build\n# Install to where Tenzir is also installed.\ncmake --install build\n# Optionally you can manually specify a non-standard Tenzir install root:\n#   cmake --install build --prefix /opt/tenzir\n# Run plugin-specific integration tests against the installed Tenzir.\ncmake --build build --target integration\n")),(0,i.yg)("h2",g({},{id:"add-unit-and-integration-tests"}),"Add unit and integration tests"),(0,i.yg)("p",null,"Tenzir comes with unit and integration tests. So does a robust plugin\nimplementation. We now look at how you can hook into the testing frameworks."),(0,i.yg)("h3",g({},{id:"unit-tests"}),"Unit tests"),(0,i.yg)("p",null,"Every plugin ideally comes with unit tests. The ",(0,i.yg)("inlineCode",{parentName:"p"},"TenzirRegisterPlugin")," CMake\nfunction takes an optional ",(0,i.yg)("inlineCode",{parentName:"p"},"TEST_SOURCES")," argument that creates a test binary\n",(0,i.yg)("inlineCode",{parentName:"p"},"<plugin>-test")," with ",(0,i.yg)("inlineCode",{parentName:"p"},"<plugin>")," being the plugin name. The test binary links\nagainst the ",(0,i.yg)("inlineCode",{parentName:"p"},"tenzir::test")," target. ou can find the test binary in ",(0,i.yg)("inlineCode",{parentName:"p"},"bin")," within\nyour build directory."),(0,i.yg)("p",null,"To execute registered unit tests, you can also simply run the test binary\n",(0,i.yg)("inlineCode",{parentName:"p"},"<plugin>-test"),", where ",(0,i.yg)("inlineCode",{parentName:"p"},"<plugin>")," is the name of your plugin. The build target\n",(0,i.yg)("inlineCode",{parentName:"p"},"test")," sequentially runs tests for all plugins and Tenzir itself."),(0,i.yg)("h3",g({},{id:"integration-tests"}),"Integration tests"),(0,i.yg)("p",null,"Every plugin ideally comes with integration tests as well. Our convention is\nthat integration tests reside in an ",(0,i.yg)("inlineCode",{parentName:"p"},"integration")," subdirectory. If you add a\nfile called ",(0,i.yg)("inlineCode",{parentName:"p"},"integration/*.bats"),", Tenzir runs them alongside the regular\nintegration tests."),(0,i.yg)("p",null,"Note that plugins may affect the overall behavior of Tenzir. Therefore we\nrecommend to to run all integrations regularly by running the build target\n",(0,i.yg)("inlineCode",{parentName:"p"},"integration"),"."),(0,i.yg)("p",null,"To execute plugin-specific integration tests only, run the build target\n",(0,i.yg)("inlineCode",{parentName:"p"},"integration-<plugin>"),", where ",(0,i.yg)("inlineCode",{parentName:"p"},"<plugin>")," is the name of your plugin."),(0,i.yg)("h2",g({},{id:"package-it"}),"Package it"),(0,i.yg)("p",null,"If you plan to publish your plugin, you may want to create a GitHub repository.\nPlease let us know if you do so, we can then link to community plugins from the\ndocumentation."),(0,i.yg)("admonition",g({},{title:"Contribute Upstream",type:"tip"}),(0,i.yg)("p",{parentName:"admonition"},"If you think your plugin provides key functionality beneficial to all Tenzir\nusers, feel free to ",(0,i.yg)("a",g({parentName:"p"},{href:"https://github.com/tenzir/tenzir/pulls"}),"submit a pull\nrequest")," to the main repository. But\nplease consider swinging by our ",(0,i.yg)("a",g({parentName:"p"},{href:"/discord"}),"community chat")," or\nstarting a ",(0,i.yg)("a",g({parentName:"p"},{href:"https://github.com/tenzir/tenzir/discussions"}),"GitHub Discussion")," to\nensure that your contribution becomes a fruitful addition. \ud83d\ude4f")))}w.isMDXComponent=!0}}]);